![](https://img.foresightnews.pro/202303/4c914cbd88fa41335894e96416eacaba.jpeg?x-oss-process=style/scale70)  


  


**事件背景**

零时科技区块链安全情报平台监控到消息，北京时间 2023 年 3 月 14 日，ETH 链上 Euler Finance 受到黑客攻击，攻击者获利约 1.97 亿美元，攻击者地址为 0xb66cd966670d962c227b3eaba30a872dbfb995db，被盗资金 100ETH 转移至混币平台 Tornado.Cash,其余资金仍在攻击者地址暂未移动。零时科技安全团队及时对此安全事件进行分析。  


  


  


**漏洞****及核心**

合约中有关代币余额修改的函数中存在检查清算的功能，在执行代币转移后检查抵押资产与借出资金，要求抵押资产大于借出资金。

![](https://img.foresightnews.pro/202303/1635f245f0cd4387d2b941a16a3f080d.png?x-oss-process=style/scale70)![](https://img.foresightnews.pro/202303/6fa831d48f0b770fabd355292a1d9e9e.png?x-oss-process=style/scale70)由于函数 donateToReserves 中缺少检查清算逻辑，攻击者可以通过此函数将借款调整为清算状态。

![](https://img.foresightnews.pro/202303/ffa9bb36276fd8523926d7eb0d07b24c.png?x-oss-process=style/scale70)攻击者构造出两个攻击合约，其中一个合约执行借款操作，另一个合约执行清算操作。

借款合约通过闪电贷借出 30,000,000 DAI，之后将 20,000,000 DAI 存入 Euler 中获得 19,568,124 eDAI，之后调用 mint 函数借出 200,000,000 dDAI 和 195,681,243eDAI，将资产放大 10 倍。

![](https://img.foresightnews.pro/202303/ad1c1ef205b3cb92e9ea1114591222a9.png?x-oss-process=style/scale70)之后攻击者调用 repay 函数继续进行质押，将剩余 10,000,000 DAI 进行质押并销毁 10,000,000 eDAI，之后继续调用 mint 函数借出 200,000,000 dDAI 和 195,681,243eDAI，此时攻击者共有 400,000,000 dDAI 和 400,930,610 eDAI。

攻击者调用合约中 donateToReserves 函数进行转账，将 100,000,000 eDAI 转移至 0 地址。

![](https://img.foresightnews.pro/202303/3919af1db70fd4552f6de36810ba0044.png?x-oss-process=style/scale70)此时攻击者地址共有 400,000,000 dDAI 和 300,930,610 eDAI，已经达到清算条件，由于此函数中缺少清算判断，未能执行清算。

清算合约调用清算函数执行清算操作，共获得 310,930,612 eDAI 和 254,234,370dDAI

![](https://img.foresightnews.pro/202303/a221d55f1940a377b0f3d4020805cfce.png?x-oss-process=style/scale70)![](https://img.foresightnews.pro/202303/7cb773e32735a99327dbed1787d3e6e7.png?x-oss-process=style/scale70)之后攻击者调用 withdraw 函数将池子中 DAI 全部取出。

![](https://img.foresightnews.pro/202303/94d1e713a8bb340b5899994e4fb27b8d.png?x-oss-process=style/scale70)此笔交易中攻击者共获利 8,877,507 DAI

  


  


**总结及建议**

此次攻击是由于 EToken 合约中 donateToReserves 函数缺失清算检查逻辑，攻击者能够恶意将借贷的资金处于清算状态下而不触发清算，使得攻击者能够无需向合约转移清算资金而触发清算从而获利。

![](https://img.foresightnews.pro/202303/c2ac491bd37a497ba1f5882f638b3763.svg?x-oss-process=style/scale70)**安全建议**

* 建议对合约中相关函数添加清算检查操作
* 建议项目方上线前进行多次审计，避免出现审计步骤缺失

  


![](https://img.foresightnews.pro/202303/b5e5a4bc9187cdecdd15c9e75ea1e42c.jpeg?x-oss-process=style/scale70)  


  


往期内容回顾

  


* [零时科技 ||《2022 年全球 Web3 行业安全研究报告》正式发布！](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487974&idx=1&sn=91851c6856447643a9b7890fefcc62d3&chksm=fc130a53cb648345ea711f2693d64a960bfabc36a0428bace1892e33cbc8fe7317bbf1e1a7c0&scene=21#wechat_redirect)
* [零时科技 || 分布式资本创始人 4200 万美金资产被盗分析及追踪工作](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487838&idx=1&sn=7326df2873ef33fef2ee865e64804440&chksm=fc130aebcb6483fdd0db1a3fa51b5fe277d342950a01c1db20a9ddfafd7edd653ad61f9e7782&scene=21#wechat_redirect)
* [零时科技 || 警惕恶意聊天软件！聊天记录被劫持损失数千万资产追踪分析](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487869&idx=1&sn=fee1aea8e3abdee2aebfe094dafbfdc3&chksm=fc130ac8cb6483de4bb74b397b596f942aefc2bcf6252f3884505e97ff0713d524e5383a2051&scene=21#wechat_redirect)
* [零时科技联合创始人黄鱼先生受邀对话《Web3 应用创新与生态安全》](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487587&idx=1&sn=b6e3032aae98cae446aa08044acf7802&chksm=fc130bd6cb6482c0c220774abf235c8e5ea62a441d6ed5c9f8e383e2d121ae6e47dc6d139cf6&scene=21#wechat_redirect)
* [零时科技创始人邓永凯先生受邀对话《公链隐私保护及生态安全》](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487577&idx=1&sn=50c75c165d0327b80fd745fe163a351f&chksm=fc130beccb6482fac9a436bd0a38b94177df1dae6a39fcb84176006891ac6588664f6a3b522f&scene=21#wechat_redirect)
* [国家网络安全宣传周|零时科技出版国内首本区块链安全书籍，助力行业发展！](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487541&idx=1&sn=ad65034445ef8e9e4816cad96f2b39ee&chksm=fc130b80cb6482960fdeafa504ef9285a125fcc311a1df7c506099d1039e747cd69101fe7393&scene=21#wechat_redirect)
* [零时科技 || Ankr 资金被盗分析](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487847&idx=1&sn=86a7b72d79c3556214716317b463f56b&chksm=fc130ad2cb6483c4e90e341f8668534cdb7ffebdebc60cebcd959c21ccbc0025758b4f352756&scene=21#wechat_redirect)
* [零时科技 || DFX Finance 攻击事件分析](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487786&idx=1&sn=4f7561945ee6681bfc28e34148f6f57c&chksm=fc130a9fcb648389f8ec81e3c678d21ed040f89c8658508cbf2db0c4cf1a9aaae50c7ffe5e28&scene=21#wechat_redirect)
* [零时科技 || Victor the Fortune 攻击事件分析](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487773&idx=1&sn=a60ebb24ab9a536db8164d664a95dc71&chksm=fc130aa8cb6483be936115617d9a4ffe959e1b8c4465952083c66997539a253d3d7cff48cd58&scene=21#wechat_redirect)
* [零时科技 || EGD 被黑客攻击损失超 3.6 万 BUSD，事件分析](http://mp.weixin.qq.com/s?__biz=MzU1OTc2MzE2Mg==&mid=2247487475&idx=1&sn=7d51ebef8546b9646c2fea7ab2a7288f&chksm=fc131446cb649d50d9f1987b68a876ee90d94d625eb9d6cb0cb8222828f19234b02f95f27b6a&scene=21#wechat_redirect)
