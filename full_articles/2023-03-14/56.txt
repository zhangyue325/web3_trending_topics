Tips
----

* Uniswap 的 AMM 机制和 Compound 的流动性挖矿是 LP 产品化的始祖
* DeFi Native 的产品应该同时面向 LP 和交互用户
* 订单簿系统作为 Web 2.5 的叙事不应该太受 Web 3 的桎梏
* Perpetual Protocol 由于 LP 产品化的问题后续发展受阻
* P2Pool Perpetual DEX 最成功的地方在于实现 LP 的产品化
* P2Pool Perpetual DEX LP 会催生出大量衍生产品
概述
--

本文叙事的主体在于 LP 的产品化，即 **DeFi 协议的流动性变成一个标准化产品的过程**。在人们最初的认知里，一个好的产品应该作为一个整体为用户服务。以 DyDx 和 0x protocol 为例，这两者将做市商内置于产品内，并通过良好的 UI 设计将其包装成一个交易平台，为 Trader 提供丝滑的交易服务并捕获交易手续费，这是一种典型的面向单一用户的产品思维。Uniswap 的 AMM 模式以及 Compound 的流动性挖矿的出现应该是 LP 产品化的始祖：AMM 模式使得 LP 和 Trader 可以交互影响；Compound 的流动性挖矿刺激了用户的存款和借款，由于借款用户的抵押品本身也可以作为流动性被借出，借款人（交互者）和存款人（LP）之间的身份界限被模糊，其提供的 LP 可以无损获取收益。

上述两个场景其实反应了 LP 产品化的特点：

* LP 在风险可控的前提下可获取标准化收益
* 提供流动性后会发行相应的 LP 票据为后续的 LP 杠杆化奠基
LP 的产品化模式在现货 AMM DEX 以及借贷协议上已经被证实是可行的方案。在目前 Perpetual DEX 的发展过程中，LP 产品化这一思路也在慢慢凸显。Perpetual DEX 的机制从 17 年到现在经历了三次大的变迁：从 DyDx 的订单簿机制到 Perpetual Protocol 的 vAMM ，再到现在的 P2Pool 交易模式。这些交易模式的变化实际上反应了链上 Perpetual DEX 的审美和形态上的变化：**DeFi 产品由面向交互用户的单一产品形式一步步转变为面向 LP 和交互用户的双产品形态。**该模式其实也回答了什么是好的 DeFi 产品的问题，即：

* **交互者体验的丝滑性，即推出交互产品**
* **LP 风险的可拆分性以及做市的简易性，即推出 LP 产品**
就目前而言，订单簿系统和 P2Pool 模式有机会实现 LP 产品化，vAMM 模式则暂时无法实现。vAMM 无法实现的原因在于目前还没有一个行之有效的 LP 管理方法，即无法对 LP 的风险和收益进行有效分割；订单簿系统辅助于一些链上融资协议和 Advisor Protocol 可以实现 LP 的收益权民主化，但 LP 的管理权仍然受限；P2Pool 模式里 GMX 的 GLP 池和 gTrade 的 gDAI 池就是典型的 LP 产品。这意味着对于 GMX 和 gTrade 而言，Perpetual Trading 是他们为 Trader 推出的交易产品，而 GLP 和 gDAI 则是为普通散户提供的收益性产品。这两个产品之间相辅相成，造就了一个逻辑自洽的系统。

在后续的行文结构里，我们将对三类 Perpetual DEX 的机制进行解读并阐述其实现 LP 产品化的可能性以及实现方式。最后我们从 DeFi 发展历史观的角度阐述为何 LP 产品化对于 DeFi 发展具有重要作用。

1. Orderbook 类交易模式
------------------

订单簿系统是目前使用范围最广、最稳健的交易模式。其从 TradFI 继承而来，提供 Perpetual 的价格发现、流动性提供以及交易的功能。目前主流的 Perp trading 产品，如 WOO Network、Orderly Network、DyDx 等都是采用订单簿交易模式。由于传统交易市场的交易模式大多为订单簿，Trader 在区块链里交互订单簿产品的迁移成本很低。另外对于做市商而言，关于订单簿系统已经存在一系列风控的工具。在风险可控的情况下，做市商可以稳定获取手续费以及客损收益。Orderbook 交易模式在 TradFi 行业已经是一类非常成熟的交易模式，但由于区块链特征与 TradFi 具有显著差异性，订单簿系统在区块链体系中可能面临着水土不服，包括：

* 由于链上 TPS 的限制，交易撮合的过程在链下实现，只有最后交易的结算才会上链
* 做市商提供的流动性虽然资金效率非常高，但无法杠杆化
* 流动性被做市商垄断，链上用户无法分享做市商收益
事实上上述所谓水土不服的问题其实并不影响订单簿模式的基本面，只是由于存在 TradFi 与 DeFi Native 的两个不同意识形态的冲撞才导致了上述问题的提出。因此在关于订单簿 DEX 未来的发展走向上，Web 3 内部分化为两个角度，一类是 Web 3 Native 的角度，另一类是实用主义的角度。

从 Web3 Native 的角度上看，订单簿数据应该上链；（目前 Sui Network 等毫秒级公链称有机会实现订单簿的完全链上化，但目前也仅能在测试网环境下实现；DyDx V4 版本也称将利用类似 mempool 的模式实现订单簿的去中心化。）订单簿系统的流动性应该寻求一定的方式进行杠杆化。

但从实用主义的角度上看，全链订单簿系统仍然面临着两个主要问题：

* 专业交易者存在隐私交易的需求，全链订单簿的存在可能会破坏私密交易的环境
* 去中心化与高性能存在一定的矛盾性的，订单簿所有数据上链实际上是对区块链中心化的妥协。相比于从撮合这个细小的层面做到中心化，整个区块链层面的中心化可能更不可接受
此外 LP 收益民主化和 LP 杠杆化的问题也面临低效和成本过高的问题。首先 LP 收益的民主化需要依赖于 Advisor Portocol 以及一些链上基金协议，即订单簿做市商在链上融资，并用融来的资金参与订单簿系统的做市，但该 LP 的管理权仍由做市商自己垄断。其次，LP 的杠杆化依赖于资金来源的民主化，做市商在链上募集资金后一般会为提供资金的用户发行一份票据，代表着该用户对于做市商部分资金的所有权。由于该票据具有做市商资金的所有权以及部分收益权，其也就具备了参与其他 DeFi 生态的基本面。在整个过程中订单簿为了实现所谓的 LP 产品化需要付出三个层面的额外成本：

* 融资成本
* 发行的 LP 票据参与其他 DeFi 生态的整合成本
* 维护 LP 退出流动性的成本
过高的成本则意味着糟糕的商业模式。因此 LP 产品化这个模式在链上有实现的可能性，但可能并非最优选择。

那么从实用主要的角度看，订单簿未来的发展趋势会是什么？订单簿作为 TradFi 的舶来品，本身的定位就应该处于 Web 2.5 的阶段。这意味着其应该各取 TradFi 和 DeFi 的优势，共同服务于 Web 3 用户：TradFi 的优势在于做市商系统以及成熟的订单簿模式；DeFi 的优势在于资产的链上结算带来的透明性以及 Token 的资产属性。合理利用 Token 的资产属性激励流动性以及配合营销是 DeFi 带给 TradFi 最好的礼物。

2. vAMM 交易模式
------------

vAMM 机制最先由 Perpetual Protocol 提出，目前有 V1 和 V2 两个版本。V1 版本是可以提供无限流动性的交易方式，交易无需多空对手盘。V1 版本里不存在 ETH - USDC 的真实流动性，但我们可以将其理解为一个 AMM 虚拟池，k 值由官方手动调整。当 Trader 进行交易时，假设其对 ETH 5x 杠杆做多，则 Perpetual Protocol 会生成 5x 的虚拟 USDC，并在该虚拟池中将该 5x 的 USDC 换成等值的 5x ETH，该 5x ETH 就相当于 Trader 的 5x 杠杆做多 ETH 的仓位。由于 V1 版本里不存在真实的流动性，上述 swap 过程并没有真实发生，我们可以将其简单的理解为一个记账过程。

在整个机制里最核心的就是 k 值的设置，其直接关系到每笔交易对于合约的价格影响。若 k 值设置的过高，合约的价格对于开仓量不敏感，影响 Trader 体验；若 k 值设置的过低，开仓量对于合约价格的影响过大，会直接造成 Trader 的损失。k 值的合理选择在于根据 CEX 的流动性实时调整。当 Perpetual Protocol 管理的池子较少时，人工主动调整 k 值是一个还算合理的选择；但当池子的数量不断增多时，人工调整则可能难以跟上市场变化。因此考虑到对 k 值进行市场化定价的问题，Perpetual Protocol 提出了 V2 版本。

Perpetual Protocol V2 利用 Uniswap V3 构造实际的「虚拟流动性」。「实际」意味着 V2 版本中确实存在真实的 LP，「虚拟流动性」则表示 Perpetual Protocol V2 内的流动性并不是常见的 AMM LP 流动性，而是虚拟生成的非实值 AMM LP。

LP 在 V2 版本中提供流动性时需要存入 USDC。以 ETH - USDC LP 为例，若 LP 想要利用 1000 USDC 提供流动性，则系统会为其最多生成 10000 vUSDC。该 LP 可以将这 10000 vUSDC 根据当前 vETH - vUSDC 的汇率换成 10000 vUSDC 等值的 vUSDC - vETH LP 交易对，在设置合理的价格区间后将该 LP 存入 Uniswap V3，为 Perpetual V2 提供流动性。（当然该 LP 也可以保留部分 vUSDC，比如只提供 8000 vUSDC 等值的流动性，剩下的 2000 vUSDC 可以被另外拿去做交易。）当 vETH - vUSDC 的流动性充裕时，LP 的 k 值自然得到了市场化的确定。

由 vAMM 模式计算出的 vETH - vUSDC LP pool 中 vETH 的价格就是 Perpetual Protocol V2 对于 ETH perp 的定价。为使 perp 的价格与现货的价格锚定，Perpetual Protocol 引入资金费率用于平衡多空。

其实我们可以对 Perpetual Protocol V2 的实际「虚拟流动性」这一抽象的概念做更为具象化的描述。LP 在存入 USDC 时生成的 vUSDC 是以 ERC- 20 的形式真实存在的，构造的 vETH - vUSDC LP 也是真实存在于 Uniswap V3 的。LP 提供的流动性本质上是在提供 vETH - vUSDC 的流动性，Trader 进行的 perp 交易本质上被转化为了 vETH - vUSDC 的现货交易，vETH 的价格就是目前该 perp 的定价。由于 vETH 的定价独立于 ETH 的定价，为使这两个价格尽可能的锚定，资金费率这一工具也就自然的被引入到了 Perpetual Protocol 中。

从上述机制中可以看出 LP 和 Trader 的界限是很不明的，主要体现在三点：

* LP 提供流动性后没有用完的 vUSDC 可以在交易账户开仓
* 当多空双方不平衡时，LP 需要作为对手方与 Trader 对赌
* LP 在提供流动性时也是提供的杠杆流动性
第二点和第三点是 LP 面临的主要风险，而且**这部分风险是 vAMM 本身机制导致的风险，没有办法通过其他方式进行对冲。**LP 作为对手方与 Trader 进行对赌的风险在于其部分 LP 仓位自动变成了交易仓位。由于 LP 在做市时自动选择了提供杠杆流动性，这意味着这部分交易仓位也是杠杆仓位， LP 需要支付资金费率，并且有被清算的可能性。

Perpetual Protocol 项目方也意识到了上述问题，通过补贴和 Insurance Fund 机制尽可能的降低 LP 面临的风险。补贴的方式主要在于当 LP 面临无常损失以及与 Trader 对赌产生的损失时，Perpetual Protocol 会补贴给 LP 一定量的 $Perp；Insurance Fund 存在的目的是当 Perpetual Protocol 内的多空不平衡时，Insurance Fund 首先作为对手方与 Trader 进行对赌，降低了 LP 可能面临的直接参与市场的风险。

总的来说，Perpetual Protocol 的 vAMM 模式在目前看来是一种 crypto native 的 perp 定价模式。该机制非常巧妙的发挥了 Uniswap V3 的交易机制的优势，但也继承了 Uniswap V3 无常损失过大的缺点。Uniswap V3 中的 LP 设置的价格区间等同于 LP 愿意跟 Trader 作为对手方的价格范围。在该价格范围内若 Trader 的买卖双方没有很平衡，那么 LP 就作为对手方与 Trader 进行博弈。同样的道理，在 Perpetual Protocol V2 中，若多空双方没有平衡，LP 就作为对手盘与 Trader 进行博弈，承担各种损益。在 CEX 中，做市商与 Trader 的博弈已经有多种成熟的风险管理策略，比如对 Delta 头寸进行限制。但由于 Perpetual V2 的交易模式是自动化而且强制性的，LP 没有办法合理管理自己的头寸风险，**当价格剧烈变动，LP 会由于无常损失以及 Trader PnL 的存在暴露较大的风险。**

Perpetual Protocol 的 V2 的模式其实也算是 P2Pool 交易模式，LP 也会在一定条件下与 Trader 进行对赌。但 vAMM 模式下 LP 的风险承受能力却远远低于 P2Pool 模式下的 LP，主要原因是 vAMM 下的 LP 是个人承担各自的风险，而 P2Pool 模式下的 LP 是共同承担所有的风险，个人的风险承受能力是远远低于集体的。对于 P2Pool 而言，由于极端行情造成的损失会被平均分摊到所有的 LP 上；但对于 vAMM 模式， 部分 LP 仓位可能会被直接清算。由于 vAMM 内 LP 获取做市收益以及承担的风险跟 LP 自身的风险管理能力是紧密相关的，而且目前也缺少关于 Uni V3 的风险管理工具，这样导致了在 Perpetual V2 上做市风险较高，而收益相对较低，LP 也没有办法以一种标准的形式参与 Perpetual Protocol 的流动性提供。给 LP 提供的补贴也是一种变相的转移支付，无法解决实际问题。**因此对于 Perpetual Protocol 而言，其 LP 难以以产品化的形式呈现出来，其后续的发展也就会受到制约。**

从数据上看，Perpetual Protocol 的 TVL 数据并不好看，问题的根源出在 LP 产品化这一端。

![](https://img.foresightnews.pro/202303/7141a7861139a8645b4e208d7a1ea2d8.png?x-oss-process=style/scale70)

  


3. P2Pool 交易模式
--------------

对于 Perpetual Protocol V2 而言， vAMM 设计确实是区块链行业交易范式的一个创新，其可以实现 Perputual 在链上的价格发现功能。但价格发现功能的代价是 LP 承担了过多的风险，这部分风险很难对冲，即意味着在收益一定的情况下，风险不可控。在 Trader 用户与 LP 体验不一致的情况下，该产品很难成长为一个通用协议。GMX 的 P2Pool 模式就是在上述背景下走上了历史舞台。P2Pool Perpetual Trading 模式并非起始于 GMX 却在 GMX 中发扬光大。其主要优势在于 trading module 可模块化，可以被拆分成 LP、交易用户、喂价系统、结算系统等部分，各部分可独立运行，同时 LP 的风险也可被拆分。

上述 PBS 的实现逻辑可以回答链上 Perpetual Trading 的定价问题。衍生品的定价需要很高的计算量和实效性。若将与衍生品价格发现相关的计算强制放置在链上，由于计算量不足造成的计算结果的延迟和误差最终会由 Trader 和 LP 共同承担。但若将与衍生品定价相关的计算放在链下，计算完毕后通过预言机将结果传输到链上，Trader 和 LP 也就不会面临由于价格发现机制造成的损失。

目前关于 P2Pool Perpetual DEX 中经典的项目包括 GMX 和 gTrade，但两者的基本机制却有很大的区别。**整体上看 GMX 相比于 gTrade 更加风险偏好，风格也更加激进；此外由于 GLP 的构成复杂性以及风险复杂性，与 GLP 相关的衍生产品相较于 gTrade 而言则更多。**

### **3.1 GMX 交易机制**

一笔交易在 GMX 上的发生需要经过多个步骤：

* GMX 通过预言机从 CEX 获取各类合约价格数据
* 根据喂价以及各个 CEX 的权重计算 GMX 上开仓的合约价格
* 根据开仓杠杆从 GLP 池中借出一部分资产，用于最后的资产结算
* 根据仓位存续的时间，支付 borrow fees 以及相应的开仓关仓手续费
GMX 通过调用 CEX 的合约价格是没有滑点的，这纵然是 GMX 吸引 Trader 的一个优势。但往往一个产品的优点也是其缺点。**由于滑点是流动性的成本，无滑点意味着有第三方为这部分成本买单。**在 GMX 的场景里最后由 GLP 池承担由滑点造成的这部分损失。（GMX 的 AVAX 主网上就曾发生过由于 AVAX 流动性不足而导致的套利行为。目前量化基金经常会根据 CEX 的流动性进行 GMX 和 CEX 之间关于滑点的套利活动。）因此无滑点交易模式本质上是通过 GLP 池补贴 Trader ，从而吸引 Trader 前来交易。但关于滑点的套利行为本身并没有成为 GMX 很严重的问题，主要原因在于 GLP 池的收益分成较高，掩盖了由于套利活动产生的损失。

GMX 的 Trader 在进行交易时需要借入资产并支付 borrow fee。而这部分 borrow fees 就是 GLP 的收益来源之一。**但此时借入资产的用途与 Gearbox 等杠杆平台的原理不同。**GMX 借出的资金是为了对每个仓位准备足额的现货供最后结算使用；而 Gearbox 则是类似于 margin trading，借出的资产就表示其实际获取的杠杆。

GLP 的另外一个收益来源在于 Trader PnL ，即 Trader 在进行交易时的亏损。由于 GMX 内并不存在资金费率用于平衡多空，GLP 持有者面临着裸空头寸，即 LP 会直接下场与 Trader 进行对赌。但这个问题从长期主义的角度上看可能并不是问题，Trader 的胜率一般小于 50%，在这种情况下 GLP 持有者最终往往是盈利状态，但短期内的收益率可能面临着较大的波动。

关于 GMX 的模式能否持续的问题，社区内经历过激烈的讨论。GMX 不可持续的论据主要体现在由于资金费率的缺失导致的 GMX 头寸的不平衡。在牛市单边行情存在的情况下， GLP 池可能面临着巨大的裸空头寸风险，具有产生大额损失的可能性。但事实上上述问题类似于回答 CEX 在牛市时如何规避裸空头寸的问题。GLP 池中支持的币种只有少数几个流动性极好的蓝筹币种，因此不会出现类似 Luna 式的单边行情。而且各大 CEX 内也有充足的流动性，GMX 官方可以通过 CEX 或者其他链上 DEX 对冲风险或者直接实行仓位限额。**整体上看 GMX 在牛市时可用的风险规避手段仍然很多。**

事实上 GMX 官方也意识到了其模式设计上可能存在的缺陷以及风险。其在 X4 版本中提到未来几个可能的改进方案，但本质上仍然是妥协：

* 为 GLP 池引入新的资产，但可开仓的标的资产仍然限制于 GLP 的组成资产
* 引入资金费率，以平衡极端行情下裸空头寸过大的问题，这意味为 Trader 在 GMX 上交易时可能需要同时支付 borrow fee 和 funding fee
* 在极端行情发生时调整 GLP 池内非稳定币与稳定币的比例，增加可开仓容量
上述这些改进方案仍然没有最终敲定，仍处于讨论阶段。关于 GMX 相关的讨论可能一直会持续下去。

因此总结下来，GMX 的特点在于：

* 交易无滑点，这部分成本由 GLP 承担
* 无资金费率，因此 GLP 可能面临着巨大的裸空头寸
* Trader 需要向 GLP 支付 borrow fee
* 受 GLP 局限，在 GMX 上只能交易部分币种，缺乏可拓展性
从 GLP 的模式设计上可以观察出 GMX 吸引的 LP 大多为高风险偏好。无论是无滑点交易模式还是裸空头寸的存在，都意味着 GLP 持有者承担较多的风险并获取风险收益。相反的，在模式设计 gTrade 则更偏向于保守和对 LP 友好。

### **3.2 Gains Network （gTrade） 交易机制**

gTrade(GNS) 原本是 Polygon 上的 Perp Trading 产品，后迁移至 Arbitrum ，其整体设计与 GMX 有巨大的差别。具体区别在于以下几点：

* 通过预言机喂价时会根据 CEX 的流动性以及仓位大小计算合约开仓的滑点以及开仓费
* 机制中引入了资金费率平衡多空，降低 gDAI 池的风险
* 结算池 (gDAI）内只存有 DAI 稳定币
* Trader 开仓无需支付 borrow fee，但需要支付展期费用
* 单个地址具有单边仓位限额，可以通过持有 NFT 增加仓位限额
* 支持多种币种、大宗商品、外汇的交易，可拓展性强
gTrade 内部的结算池只有 DAI，而且其资金规模远远小于 gTrade 的日交易量。在协议不引入滑点的情况下，套利者通过滑点套利很容易造成结算池的损失；多空资金费率的引入也是尽量保证结算池不会存在较多的裸空头寸，降低结算池的风险；展期费用存在的目的是降低时间风险，尽量避免由于盈利仓位的长持导致结算池的一次性巨额损失；单边仓位限制也是为了避免结算池的巨额损失。因此从 gTrader 的机制设计上看可以看出，其风格相比于 GMX 而言是风险厌恶的。机制设计上有各种风控机制保证 gDAI 池的资金安全。

### **3.3 P2Pool 机制下的 LP 产品**

GLP 和 gDAI 已经是较为完善了 LP 产品了，但对于 GLP 而言，由于 GMX 并未使用资金费率来平衡多空，GLP pool 经常存在着大额裸空头寸，相当于 GLP Pool 被迫作为对手盘与 Trader 进行博弈。此外， GLP 的构成包括 BTC、ETH、Link、Uni 以及 stable coin，GLP 的价值会随着其构成现货价值的波动而产品波动，这意味着币价也是影响 GLP 损益的重要因素。因此**整体上，GLP 的风险可以被简单拆分为两个互不相干的风险：Delta risk 和 Trader PnL risk。**

风险的可拆分性意味着有对 GLP 进行衍生化开发的可能性。**目前已经有大量协议在尝试 Hedge GLP 面临的 Delta risk，比如 GMD Protocol，Umami Finance 和 Rage Trade 等。**但 Trader PnL risk 可能难以从衍生品的角度去对冲，可行的方案在于 GMX 内部机制改进或者尝试在其他 DEX 或者 CEX 进行对冲。

4. 为什么 LP 产品化对于 DeFi 的发展很重要？
----------------------------

对整个 DeFi 的发展史进行梳理后我们可以得到一个简单的三层架构：

![](https://img.foresightnews.pro/202303/7e51258ec1f418dd466b465c9e798dca.png?x-oss-process=style/scale70)

  


* 第一层为核心币种，即 ETH、BTC 等可以蓝筹核心资产
* 第二层为 DEX、借贷和稳定币
* 第三层为所谓的 DeFi 2.0 协议
这三层架构的连接逻辑也很简单。第一层与第二层的连接逻辑在于**为核心币种加杠杆**；第二层与第三层的连接逻辑则在于 **DeFi 协议之间的可组合性**。为核心币种加杠杆是所有公链在搭建自己 DeFi 生态时必须要经历的一个阶段，这样才可以根据杠杆性，搭建出一个内生性的 DeFi 生态。值得注意的是第二层与第三层的连接，即协议之间的可组合性，需要依赖于第二层协议产生的真实收益。**换句话说协议之间的可组合性其实反应了真实收益在不同协议之间的流动。**

目前链上可以产生真实收益的场景并不多，包括：

* 金融服务费，如交易手续费、借贷费用等
* 贿选费用
* Staking Yield
这些存在真实收益的场景也就是 DeFi 相关产品发展的基础。从上个 DeFi 周期已经被证明的叙事上看，推动初始 DeFi 协议发展的核心发动机可以归结为下图：

![](https://img.foresightnews.pro/202303/7f0ec85817ab74214e7c77bf282f4d62.png?x-oss-process=style/scale70)

  


虽然在现在看来当时 Yearn Finance 给出的策略过于简单，但其极大的促进了 DeFI 的发展。LP 产品化后 DeFI 协议 TVL 的增加进入快车道，TVL 的增加也使得交互用户对于 DeFi 产品的体验感增加。此外，LP 产品化也使得 LP 存在杠杆化的可能性，使其成为后续衍生品产品的开发与集成、搭建 DeFi lego 的基础。

因此对于 Perpetual DEX 而言，LP 产品化之路其实也只是在复刻初始 DeFi 协议发展的逻辑。那么感想是什么？**一个未充分显现的叙事其实就存在于以往的故事中，只是这个故事换了封面之后被人遗忘在了角落。当人们突然想起这个故事可以换一种方式讲的时候，它便又面目一新，但若追根溯源，这个故事的内核一直存在于逝去的时间长河里。**

